---
title: "IRT Voraussetzungen"
author: "Nicklas Hafiz"
date: "`r format(Sys.time(), '%d %B, %Y')`"
format: 
  letterbox-revealjs:
    embed-resources: true
    logo: "../../images/iqb.svg"
    footer: <https://nickhaf.github.io/IRT_workshop/slides/>
---

```{r}
library(tidyverse)
```

# Überblick 

## Voraussetzungen der Item Response Theory

- Eindimmensionalität
- Lokal Stochastische Unabhänigkeit (https://files.eric.ed.gov/fulltext/EJ1224232.pdf). 

## Eindimmensionalität
- Wenn nicht gegeben:
    - SEM
    - Dependency Matrix

## Lokal stochastische Unabhängigkeit
Nach Kontrolle für die Personenfähigkeit korrelieren die Items nicht mehr. Der einzige Grund dafür, dass die Items zusammenhängen, ist also, dass die Antwort von diesem Konstrukt beeinflusst wird. 
Durch die Kontrolle für die Personenfähigkeit halten wir also den Fähigkeitswert konstant (alle Personen haben die gleiche Fähigkeit), 

- Abbildung
- Einordnung: Lokale Unabhängigkeit, weitere Begriffe?
- Beispiel

# Linking

## Problem
Wir haben die Invarianz-Eigenschaft von IRT bereits kennen gelernt: 
**Itemparameter sind gleich über verschiedene Gruppen.**
Die Wahrscheinlichkeit für eine korrekte Antwort auf ein Item hängt nur von $\theta$ ab. Nicht von anderen Personen in der Stichprobe. 

Wie schaffen wir das aber, wenn wir anhand von verschiedenen Gruppen kalibrieren?
Wir müssen die Werte, die wir aus diesen Kalibrierungen bekommen, irgendwie in einen Zusammenhang setzen. 

## Wiederholung: Kalibrierung
- Kalibrierung: schätzen von Itemparametern und Personenfähigkeiten
- Erst einmal nur für **diese bestimmte Kombintation aus Items und Personen**

WARUM?


## Wiederholung: Kalibrierung
- Skala der Latenten Variable wird arbiträr festgelegt auf einen Mittelwert von 0 und eine SD von 1  
- Modell? sonst nicht idenfiziert. 
- Itemparameter dadurch **nicht** auf der selben Skala
- **Sie können also nicht direkt miteinander verglichen werden.**

## Beispiel 
Sie hängen ja von den latenten VAriablen in der Stichprobe ab. Wenn wir eine sehr gute Stichprobe haben, und eine sehr schwache, dann werden trotzdem bei beiden der Mittelwert der Latenten Variable 0 und die SD 1 sein. Mittelschwere Items werden aber in der schwachen Gruppe eher positive Schwierigkeiten haben, in der starken Gruppe eher negative. (Beispiel nochmal genauer ausführen, evtl. mit Grafik, Ich hatte dazu etwas im ersten Buch, dass ich gelesen habe). 


## Beispiel
Group 1: $\theta \sim N(0,1)$
Group 2: $\theta \sim N(1, 1.4)$

Für die Kalibrierung legen wir jetzt aber fest, dass gilt:
Group 1: $\theta \sim N(0,1)$
Group 2: $\theta \sim N(0,1)$

## Beispiel 
```{r}
data_lines <- data.frame(
    x = c(-4:4, -4:4),
    y = c(rep(2, 9), rep(1, 9)), 
    group = c(rep("1", 9), rep("2", 9)), 
    label = c(-4:4, -3:5)
)

ggplot(data_lines, aes(x, y, group=group)) +
  geom_line() +
  geom_point() +
        ggthemes::theme_tufte() +
        theme(
            axis.title = element_blank(), 
            axis.text = element_blank(), 
        axis.line = element_blank(),
        axis.ticks = element_blank()) +
        ylim(0,3) +
        geom_text(aes(label = label), vjust = 1.5)  # Add labels to the points





```

## Simulate data

```{r}
#| eval: FALSE

calc_2pl <- function(a, theta, xi){
  psi <- (exp(a*(theta - xi)))/(1 + exp(a*(theta - xi))) 
  return(psi) 
}


theta_data <- data.frame(
    person = 1:2000000,
    theta = c(rnorm(1000000, 0, 1), rnorm(1000000, 1, 2)),
    group = c(rep("1", 1000000), rep("2", 1000000))
)

items <- data.frame(
    id = 1:13, 
    b = seq(-3, 3, by = 0.5), 
    a = seq(0.5, 3.5, by = 0.25), 
    c = rep(0, 13)
)

sim_dat <- merge(theta_data, items) %>%
    mutate(prop = calc_2pl(a, theta, b)) %>%
    mutate(Answer = rbinom(n = nrow(.), size = 1, prob = prop))

## could also try sim_irt

## With sim_irt
library(catIrt)

simirt_dat <- simIrt(theta =rnorm(1000000, 0, 1), params = as.matrix(items[, c("a", "b", "c")]), mod = "brm")

```


```{r}
#| eval: FALSE

## Analyze with a package to see if everything worked. 
library(mirt)
library(TAM)

## Into wide format
sim_dat_wide <- sim_dat %>%
    filter(group == "1") %>%
    select(id, Answer, theta, person) %>%
    pivot_wider(names_from = id, values_from = Answer, id_cols = person)

fit2PL <- tam.mml.2pl(sim_dat_wide %>% select(-person), irtmodel = "2PL")
# saveRDS(fit2PL, file = "./slides/Vorraussetzung/dat/fit2PL.RDS")

fit2PL$item_irt
# Actually worked! 


fit2PL_2 <- tam.mml.2pl(as.data.frame(simirt_dat$resp), irtmodel = "2PL")
# saveRDS(fit2PL_2, file = "./slides/Vorraussetzung/dat/fit2PL_simfun.RDS")

fit2PL_2$item_irt
# This worked fairly well

fit2PL <- mirt(data = sim_dat_wide %>% select(-person), 
               itemtype = "2PL", 
               verbose = FALSE)

params2PL <- coef(fit2PL, IRTpars = TRUE, simplify = TRUE)
```

## Schlusfolgerung
- Wir brauchen also einen Referenzrahmen um unsere Testergebnisse interpretieren zu können. 
- Das bedeutet auch, dass wir die Werte aus verschiedenen Kalibrierungen nicht direkt miteinander vergleichen können.
- Lösung: **Linking**


## {background-image="images/link.jpg" background-size="1150px"}

::: {.absolute right="5%" top="0%" style="font-size:2em; padding: 0.5em 0.5em; background-color: rgba(255, 255, 255, .7); backdrop-filter: blur(5px); box-shadow: 0 0 1rem 0 rgba(255, 255, 255, .5); border-radius: 5px;"}

Linking/Equating

:::

::: aside
Foto von [Bryson Hammer](https://unsplash.com/de/@trhammerhead?utm_content=creditCopyText&utm_medium=referral&utm_source=unsplash) auf [Unsplash](https://unsplash.com/de/fotos/selektives-fokusfoto-von-grauen-metallketten-JZ8AHFr2aEg?utm_content=creditCopyText&utm_medium=referral&utm_source=unsplash). 

::: 

<!-- https://hectornajera83.github.io/book/scale-equating-and-linking.html -->


## Identifizirbarkeit


## Beispiel


## Linking/Equating
- Szenario: Wir haben verschiedene Testformen, und wollen die Scores auf eine gemeinsame Skala bringen. 
- Dafür haben wir zwei Möglichkeiten:
    - Gemeinsame Items
    - Gemeinsame Personen

Abbildung z.B. mit Verteilung von theta scores, die nochmal zeigt was das Problem ist. 
Dann kann man bestimmte Items markieren, und die Verteilungen entsprechend dieser markierten Items verschieben. 

Embretson 2000, S. 253

- Item Parameter werden in beiden Tests geschätzt, und dann anhand der Ankeritems durch eine geeignete Transformation auf eine gemeinsame Skala gebracht.

## Beispiel
- Schulvergleichsstudien über die Jahre:
- Itempools von Unternehmen, die Einstellungstests anbieten. 

## Ankeritems

:::: {.columns} 
::: {.column width="50%"}

- Gemeinsame Items, die in beiden Testformen vorhanden sind. 
- Sollten keinen DIF haben.Genauer recherchieren: How to choose anchor items. 

:::


::: {.column width="50%"}

![](images/anker.jpg){.image-right}

:::

::::

## Ankeritems
- Kallibrierungen der Parameterschätzer aus zwei verschiedenen Testformen werden auf eine gemeinsame Skala gebracht.
- Wir müssen also die theta ($\theta$) scores des einen Tests so transformieren, dass sie auf einer gemeinsamen Skala mit den Scores des anderen Tests liegen:

$$
\theta_Y = A \theta_X + B
$$

## Ankerpersonen
Personen bearbeiten beide Tests. Personenfähigkeit wird basierend auf einem Referenztest geschätzt, und dann fixiert und konstant gehalten, wenn andere Testformen bearbeitet werden. Die Fähigkeitswerte werden dann genutzt, um Itemparameter auf beiden Testformen zu schätzen. 


## Linking 

$$
\theta* = x\theta+y
$$

...

## Linking
Ziel: "Linking constants" $x$ und $y$ findend, welche die Item parameter aus den beiden Gruppen auf der selben Skala plazieren. 
Deutlich machen, für welche Art Modell nutzbar!
Nochmal mit dem neueren Buch rübergehen, das geht noch mehr in die Tiefe. 

- Zwei häufige Methoden:
    - mean-sigma:
        - Annahme: Gemeinsame Ankeritems, oder Zwei Gruppen haben den genau gleichen Test bearbeitet. 
$$
B_B^* = x\beta_b=y
$$

$$
x = \frac{\sigma_A}{\sigma_B}
$$

$$
y = \overline{\beta}_A - x(\overline{\beta}_B)
$$

Und dann einsetzen in 
$$
\theta* = x\theta+y
$$ 

etc. 

mal ausprobieren!

## mean-sigma


Probleme: linking constants können stark von Outliern beeinflusst werden, und von den differential standards errors of the item difficutly estimates
- Robust procedures exist. 

Nur die  item difficulty parameters werden zur berechnung der Linking constants genutzt. 

Alternative: Characteristic curve methods

## Characteristic curve methods
Versuch, die Linking constants so zu berechnen, dass die test charctersitic curves so ähnlich wie möglich sind. Nutzen daher alle item parameter um die Linking constants zu finden.  computationally more expensive. 
Empirical research zeigt keine großen Unterschide zwischen beiden Methoden? Nochmal selber recherchiereen. 

## Gibt es neuere methoden? Z.B. Multi-group IRT, CFA framework ...?

## Beispiel
Im Embretson machen sie eine kleine Simulation. Könnten wir auch machen, entweder als aufgabe oder demonstrieren. 
-  Man könnte die Linking constants setzen, gukcen was das mit den schwierikeiten macht, und die Simulierten Werte wieder rekapitulieren. 



# Messinvarianz/DIF

## Das Problem
- Funktionieren die Items in verschiedenen Gruppen (z.B. Geschlecht, Kultur, Fähigkeit ...) auf dieselbe Art und Weise?
- Gibt es also echte Mittelwertsunterschiede zwischen beiden Gruppen, oder sind die Unterschiede auf Besondere Interaktionen zwischen Items und Gruppen zurückzuführen?


## DIF
- Wenn wir das auf bestimmte Items anwenden, sprechen wir von Differential Item Functioning. 

Raschtrees vorstellen?
Ansonsten Embretson ab Linking auch gut. 


## Was wird Überprüft? 




## Beispiel was bei nichtbeachtung passiert




