---
title: "Partial Credit Model"
subtitle: "Übung"
format: html
about:
  id: pcm-heading
  template: marquee
  image: images/friends.jpg
---

:::{#pcm-heading}

## Die Daten

- Kontinuierliche Skala in Likert Skala umgewandelt (nicht optimal, Infos gehen verloren)
- Wir können jetzt auch nicht wirklich sagen, was die verschiedenen Kategorien aussagen (außer 1 und 5).

:::

::: aside
Foto von <a href="https://unsplash.com/de/@lgtts?utm_content=creditCopyText&utm_medium=referral&utm_source=unsplash">Ilse Orsel</a> auf <a href="https://unsplash.com/de/fotos/rot-weisses-unks-cafe-fwPHQB4kGzA?utm_content=creditCopyText&utm_medium=referral&utm_source=unsplash">Unsplash</a>
:::

```{r}
#| message: false

library(TAM)
library(psych)
library(tidyverse)
library(eRm)
```

# Daten laden und umkodieren

```{r}
psych_dat <- readRDS(here::here("raw_data", "psych_pcm.rds"))

## Kategorien müssen bei 0 anfangen
psych_dat <- psych_dat - 1

## Zu allen characteren liegen Infos vor
any(is.na(psych_dat))
```

# PCM Modell fitten: `TAM`

```{r}
pcm_psych <- tam.mml(psych_dat[, -1], irtmodel = "PCM", verbose = FALSE)

summary(pcm_psych)

pcm_psych$xsi

## Identify items with disordered category thresholds
g <- pcm_psych$item_irt
gg <- g[g$tau.Cat1 > g$tau.Cat2 | g$tau.Cat2 > g$tau.Cat3 | g$tau.Cat3 > g$tau.Cat4, ]

deltas <- pcm_psych$xsi

## Plot the option characteristic curves
plot(pcm_psych,
  type = "items",
  export = FALSE,
  package = "graphics",
  observed = FALSE,
  low = -6,
  high = 6
)



## Plot the empirical and theoretical expected scores curves

plot(pcm_psych,
  type = "expected",
  ngroups = 6,
  low = -6,
  high = 6,
  package = "lattice", overlay = FALSE
)

## Q3 Statistic
q3 <- tam.modelfit(pcm_psych)$stat.itempair
q3 <- data.frame(q3[1:2], round(q3[5:6], 2), round(q3[7:8], 4))
```


# PCM Modell fitten: `eRm`

```{r eRm}
erm_pcm <- PCM(psych_dat)
summary(erm_pcm)

plotPImap(erm_pcm)
plotICC(erm_pcm, ask = FALSE)

thresholds(erm_pcm)

item_fit_pcm <- eRm::itemfit(person.location.estimate)
```

## Residualplot

```{r}
stresid <- item_fit_pcm$st.res

# before constructing the plots, find the max & min residuals:
max.resid <- ceiling(max(stresid))
min.resid <- ceiling(min(stresid))

for (item.number in colnames(stresid)) {
  plot(stresid[, item.number],
    ylim = c(min.resid, max.resid),
    main = paste("Standardized Residuals for Item ", item.number, sep = ""),
    ylab = "Standardized Residual", xlab = "Person Index"
  )
  abline(h = 0, col = "blue")
  abline(h = 2, lty = 2, col = "red")
  abline(h = -2, lty = 2, col = "red")
  legend("topright", c("Std. Residual", "Observed = Expected", "+/- 2 SD"),
    pch = c(1, NA, NA),
    lty = c(NA, 1, 2),
    col = c("black", "blue", "red"), cex = .8
  )
}
```
